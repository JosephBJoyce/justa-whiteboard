<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Local Whiteboard</title>

<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #fff;
    font-family: system-ui, sans-serif;
  }

  #toolbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    gap: 8px;
    padding: 8px;
    background: #fafafa;
    border-bottom: 1px solid #e5e5e5;
    z-index: 10;
  }

  button {
    padding: 6px 10px;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
  }

  button.active {
    border-color: black;
    font-weight: 600;
  }

  canvas {
    position: absolute;
    top: 48px;
    left: 0;
    cursor: crosshair;
  }
</style>
</head>

<body>

<div id="toolbar">
  <button data-tool="draw" class="active">Draw</button>
  <button data-tool="rect">Rectangle</button>
  <button data-tool="circle">Circle</button>
  <button data-tool="arrow">Arrow</button>
  <button data-tool="text">Text</button>
  <button id="undo">Undo</button>
  <button id="clear">Clear</button>
</div>

<canvas id="board"></canvas>

<script>
/* -----------------------------
   Core State
--------------------------------*/
const state = {
  tool: "draw",
  mode: "idle",          // idle | drawing | placingText
  history: [],
  currentStroke: null,
  startPoint: null,
  textAnchor: null
};

const canvas = document.getElementById("board");
const ctx = canvas.getContext("2d");
const TOOLBAR_HEIGHT = 48;
const COLOR = "#000";

/* -----------------------------
   Setup
--------------------------------*/
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - TOOLBAR_HEIGHT;
  render();
}
window.addEventListener("resize", resize);
resize();

/* -----------------------------
   Toolbar
--------------------------------*/
document.querySelectorAll("[data-tool]").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("[data-tool]").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    state.tool = btn.dataset.tool;
    state.mode = "idle";
    state.textAnchor = null;
    render();
  });
});

document.getElementById("undo").onclick = () => {
  state.history.pop();
  render();
};

document.getElementById("clear").onclick = () => {
  state.history = [];
  state.mode = "idle";
  state.textAnchor = null;
  render();
};

/* -----------------------------
   Input Handling
--------------------------------*/
canvas.addEventListener("mousedown", e => {
  const x = e.offsetX;
  const y = e.offsetY;

  if (state.tool === "text") {
    state.mode = "placingText";
    state.textAnchor = { x, y };
    render();

    const text = prompt("Enter text:");
    if (text) {
      state.history.push({ type: "text", x, y, text });
    }

    state.mode = "idle";
    state.textAnchor = null;
    render();
    return;
  }

  state.mode = "drawing";
  state.startPoint = { x, y };

  if (state.tool === "draw") {
    state.currentStroke = [{ x, y }];
    state.history.push({ type: "draw", points: state.currentStroke });
  }
});

canvas.addEventListener("mousemove", e => {
  if (state.mode !== "drawing") return;

  if (state.tool === "draw") {
    state.currentStroke.push({ x: e.offsetX, y: e.offsetY });
    render();
  }
});

canvas.addEventListener("mouseup", e => {
  if (state.mode !== "drawing") return;

  if (state.tool !== "draw") {
    state.history.push({
      type: state.tool,
      x1: state.startPoint.x,
      y1: state.startPoint.y,
      x2: e.offsetX,
      y2: e.offsetY
    });
  }

  state.mode = "idle";
  state.currentStroke = null;
  render();
});

/* -----------------------------
   Rendering
--------------------------------*/
function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = COLOR;
  ctx.fillStyle = COLOR;
  ctx.lineWidth = 2;

  state.history.forEach(item => {
    if (item.type === "draw") {
      ctx.beginPath();
      item.points.forEach((p, i) =>
        i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y)
      );
      ctx.stroke();
    }

    if (item.type === "rect") {
      ctx.strokeRect(item.x1, item.y1, item.x2 - item.x1, item.y2 - item.y1);
    }

    if (item.type === "circle") {
      const r = Math.hypot(item.x2 - item.x1, item.y2 - item.y1);
      ctx.beginPath();
      ctx.arc(item.x1, item.y1, r, 0, Math.PI * 2);
      ctx.stroke();
    }

    if (item.type === "arrow") {
      drawArrow(item.x1, item.y1, item.x2, item.y2);
    }

    if (item.type === "text") {
      ctx.font = "16px system-ui";
      ctx.fillText(item.text, item.x, item.y);
    }
  });

  if (state.textAnchor) {
    drawTarget(state.textAnchor.x, state.textAnchor.y);
  }
}

/* -----------------------------
   Helpers
--------------------------------*/
function drawTarget(x, y) {
  ctx.save();
  ctx.setLineDash([4, 4]);
  ctx.lineWidth = 1;

  ctx.beginPath();
  ctx.moveTo(x - 10, y);
  ctx.lineTo(x + 10, y);
  ctx.moveTo(x, y - 10);
  ctx.lineTo(x, y + 10);
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(x, y, 5, 0, Math.PI * 2);
  ctx.stroke();

  ctx.restore();
}

function drawArrow(x1, y1, x2, y2) {
  const angle = Math.atan2(y2 - y1, x2 - x1);
  const head = 10;

  ctx.beginPath();
  ctx.moveTo(x1, y1);
  ctx.lineTo(x2, y2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(x2, y2);
  ctx.lineTo(
    x2 - head * Math.cos(angle - Math.PI / 6),
    y2 - head * Math.sin(angle - Math.PI / 6)
  );
  ctx.lineTo(
    x2 - head * Math.cos(angle + Math.PI / 6),
    y2 - head * Math.sin(angle + Math.PI / 6)
  );
  ctx.closePath();
  ctx.fill();
}
</script>

</body>
</html>